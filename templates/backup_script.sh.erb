#!/bin/sh

TIMESTAMP=`date +%Y-%m-%d`

mysqldump -h <%= node['mediawiki_application']['database']['host'] %>  -u <%= node['mediawiki_application']['database']['user_name'] %> -p '<%= @db_password %>' <%= node['mediawiki_application']['database']['db_name'] %> -c > '<%= node['mediawiki_application']['database']['backup']['directory'] %>/backup_${TIMESTAMP}.sql'

cp '<%= node['mediawiki_application']['database']['backup']['directory'] %>/backup_${TIMESTAMP}.sql' '<%= node['mediawiki_application']['database']['backup']['directory'] %>/backup_latest.sql'

<% if node['mediawiki_application']['database']['backup_to_s3'] -%>
# Copy both files to S3
aws s3 cp '<%= node['mediawiki_application']['database']['backup']['directory'] %>/backup_${TIMESTAMP}.sql'
aws s3 cp '<%= node['mediawiki_application']['database']['backup']['directory'] %>/backup_latest.sql'
<% end -%>
